<?xml version="1.0" encoding="utf-8"?>

<Page
    x:Class="Coder.Desktop.App.Views.Pages.FileSyncListMainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:Coder.Desktop.App.ViewModels"
    xmlns:converters="using:Coder.Desktop.App.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid
            Visibility="{x:Bind ViewModel.ShowUnavailable, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}"
            Padding="60,60"
            HorizontalAlignment="Center"
            VerticalAlignment="Center">

            <TextBlock
                HorizontalAlignment="Center"
                Text="{x:Bind ViewModel.UnavailableMessage, Mode=OneWay}" />
        </Grid>

        <Grid
            Visibility="{x:Bind ViewModel.ShowLoading, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}"
            Padding="60,60"
            HorizontalAlignment="Center"
            VerticalAlignment="Center">

            <ProgressRing
                Width="32"
                Height="32"
                Margin="0,30"
                HorizontalAlignment="Center" />

            <TextBlock HorizontalAlignment="Center" Text="Loading sync sessions..." />
        </Grid>

        <StackPanel
            Visibility="{x:Bind ViewModel.ShowError, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}"
            Orientation="Vertical"
            Padding="20">

            <TextBlock
                Margin="0,0,0,20"
                Foreground="Red"
                TextWrapping="Wrap"
                Text="{x:Bind ViewModel.Error, Mode=OneWay}" />

            <Button Command="{x:Bind ViewModel.ReloadSessionsCommand, Mode=OneWay}">
                <TextBlock Text="Reload" />
            </Button>
        </StackPanel>

        <!-- This grid lets us fix the header and only scroll the content. -->
        <Grid
            Visibility="{x:Bind ViewModel.ShowSessions, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <StackPanel
                Grid.Row="0"
                Orientation="Vertical"
                Padding="30,15,30,0">

                <!--
                    We use separate grids for the header and each child because WinUI 3
                    doesn't support having a dynamic row count.

                    This unfortunately means we need to copy the resources and the
                    column definitions to each Grid.
                -->
                <Grid Margin="0,0,0,5">
                    <Grid.Resources>
                        <Style TargetType="TextBlock">
                            <Setter Property="Foreground" Value="{ThemeResource TextFillColorSecondaryBrush}" />
                        </Style>
                        <Style TargetType="Border">
                            <Setter Property="Padding" Value="40,0,0,0" />
                        </Style>
                    </Grid.Resources>

                    <!-- Cannot use "Auto" as it won't work for multiple Grids. -->
                    <Grid.ColumnDefinitions>
                        <!-- Icon column: 14 + 5 padding + 14 + 10 padding -->
                        <ColumnDefinition Width="43" />
                        <ColumnDefinition Width="2*" MinWidth="200" />
                        <ColumnDefinition Width="1*" MinWidth="120" />
                        <ColumnDefinition Width="2*" MinWidth="200" />
                        <ColumnDefinition Width="1*" MinWidth="100" MaxWidth="200" />
                        <ColumnDefinition Width="1*" MinWidth="100" MaxWidth="200" />
                    </Grid.ColumnDefinitions>

                    <Border Grid.Column="1" Padding="10,0,0,0">
                        <TextBlock Text="Local Path" />
                    </Border>
                    <Border Grid.Column="2">
                        <TextBlock Text="Workspace" />
                    </Border>
                    <Border Grid.Column="3">
                        <TextBlock Text="Remote Path" />
                    </Border>
                    <Border Grid.Column="4">
                        <TextBlock Text="Status" />
                    </Border>
                    <Border Grid.Column="5">
                        <TextBlock Text="Size" />
                    </Border>
                </Grid>

                <Border
                    Height="1"
                    Margin="-30,0,-30,5"
                    Background="{ThemeResource ControlElevationBorderBrush}" />
            </StackPanel>

            <ScrollView Grid.Row="1">
                <StackPanel Orientation="Vertical" Padding="30,0,30,15">
                    <ItemsRepeater ItemsSource="{x:Bind ViewModel.Sessions, Mode=OneWay}">
                        <ItemsRepeater.Layout>
                            <StackLayout Orientation="Vertical" />
                        </ItemsRepeater.Layout>

                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="viewmodels:SyncSessionViewModel">
                                <Grid Margin="0,10">
                                    <!-- These are (mostly) from the header Grid and should be copied here -->
                                    <Grid.Resources>
                                        <Style TargetType="Border">
                                            <Setter Property="Padding" Value="40,0,0,0" />
                                        </Style>
                                    </Grid.Resources>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="43" />
                                        <ColumnDefinition Width="2*" MinWidth="200" />
                                        <ColumnDefinition Width="1*" MinWidth="120" />
                                        <ColumnDefinition Width="2*" MinWidth="200" />
                                        <ColumnDefinition Width="1*" MinWidth="100" MaxWidth="200" />
                                        <ColumnDefinition Width="1*" MinWidth="100" MaxWidth="200" />
                                    </Grid.ColumnDefinitions>

                                    <Border Grid.Column="0" Padding="0" HorizontalAlignment="Right">
                                        <StackPanel Orientation="Horizontal">
                                            <HyperlinkButton
                                                Padding="0"
                                                Margin="0,0,5,0"
                                                Command="{x:Bind PauseOrResumeSessionCommand, Mode=OneWay}">

                                                <FontIcon Glyph="{x:Bind Icon, Mode=OneWay}" FontSize="15"
                                                          Foreground="{ThemeResource DefaultTextForegroundThemeBrush}" />
                                            </HyperlinkButton>
                                            <HyperlinkButton
                                                Padding="0"
                                                Command="{x:Bind TerminateSessionCommand, Mode=OneWay}">

                                                <FontIcon Glyph="&#xF140;" FontSize="15"
                                                          Foreground="{ThemeResource DefaultTextForegroundThemeBrush}" />
                                            </HyperlinkButton>
                                        </StackPanel>
                                    </Border>
                                    <Border Grid.Column="1" Padding="10,0,0,0">
                                        <TextBlock
                                            Text="{x:Bind Model.AlphaPath}"
                                            TextTrimming="CharacterEllipsis"
                                            IsTextTrimmedChanged="TooltipText_IsTextTrimmedChanged" />
                                    </Border>
                                    <Border Grid.Column="2">
                                        <TextBlock
                                            Text="{x:Bind Model.BetaName}"
                                            TextTrimming="CharacterEllipsis"
                                            IsTextTrimmedChanged="TooltipText_IsTextTrimmedChanged" />
                                    </Border>
                                    <Border Grid.Column="3">
                                        <TextBlock
                                            Text="{x:Bind Model.BetaPath}"
                                            TextTrimming="CharacterEllipsis"
                                            IsTextTrimmedChanged="TooltipText_IsTextTrimmedChanged" />
                                    </Border>
                                    <Border Grid.Column="4">
                                        <Border.Resources>
                                            <converters:StringToBrushSelector
                                                x:Key="StatusColor"
                                                SelectedKey="{x:Bind Path=Model.StatusCategory}">

                                                <converters:StringToBrushSelectorItem
                                                    Value="{ThemeResource SystemFillColorCriticalBrush}" />
                                                <converters:StringToBrushSelectorItem
                                                    Key="Paused"
                                                    Value="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                                                <converters:StringToBrushSelectorItem
                                                    Key="Halted"
                                                    Value="{ThemeResource SystemFillColorCriticalBrush}" />
                                                <converters:StringToBrushSelectorItem
                                                    Key="Error"
                                                    Value="{ThemeResource SystemFillColorCriticalBrush}" />
                                                <converters:StringToBrushSelectorItem
                                                    Key="Conflicts"
                                                    Value="{ThemeResource SystemFillColorCautionBrush}" />
                                                <converters:StringToBrushSelectorItem
                                                    Key="Working"
                                                    Value="{ThemeResource SystemFillColorAttentionBrush}" />
                                                <converters:StringToBrushSelectorItem
                                                    Key="Ok"
                                                    Value="{ThemeResource DefaultTextForegroundThemeBrush}" />
                                            </converters:StringToBrushSelector>
                                        </Border.Resources>
                                        <TextBlock
                                            Text="{x:Bind Model.StatusString}"
                                            TextTrimming="CharacterEllipsis"
                                            Foreground="{Binding Source={StaticResource StatusColor}, Path=SelectedObject}"
                                            ToolTipService.ToolTip="{x:Bind Model.StatusDetails}" />
                                    </Border>
                                    <Border Grid.Column="5">
                                        <TextBlock
                                            Text="{x:Bind Model.AlphaSize.SizeBytes, Converter={StaticResource FriendlyByteConverter}}"
                                            ToolTipService.ToolTip="{x:Bind Model.SizeDetails}" />
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>

                    <!-- "New Sync" button -->
                    <!--
                        HACK: this has some random numbers for padding and margins. Since
                        we need to align the icon and the text to the two grid columns
                        above (but still have it be within the same button), this is the
                        best solution I could come up with.
                    -->
                    <HyperlinkButton
                        Margin="13,5,0,0"
                        Command="{x:Bind ViewModel.StartCreatingNewSessionCommand}"
                        Visibility="{x:Bind ViewModel.CreatingNewSession, Converter={StaticResource InverseBoolToVisibilityConverter}, Mode=OneWay}">

                        <StackPanel Orientation="Horizontal">
                            <FontIcon
                                FontSize="18"
                                Margin="0,0,10,0"
                                Glyph="&#xE710;"
                                Foreground="{ThemeResource SystemFillColorSuccessBrush}" />
                            <TextBlock
                                Text="New Sync"
                                Foreground="{ThemeResource DefaultTextForegroundThemeBrush}" />
                        </StackPanel>
                    </HyperlinkButton>

                    <!-- New item Grid -->
                    <Grid
                        Margin="0,10"
                        Visibility="{x:Bind ViewModel.CreatingNewSession, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}">

                        <!-- These are (mostly) from the header Grid and should be copied here -->
                        <Grid.Resources>
                            <Style TargetType="Border">
                                <Setter Property="Padding" Value="40,0,0,0" />
                            </Style>
                        </Grid.Resources>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="43" />
                            <ColumnDefinition Width="2*" MinWidth="200" />
                            <ColumnDefinition Width="1*" MinWidth="120" />
                            <ColumnDefinition Width="2*" MinWidth="200" />
                            <ColumnDefinition Width="1*" MinWidth="100" MaxWidth="200" />
                            <ColumnDefinition Width="1*" MinWidth="100" MaxWidth="200" />
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Padding="0">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <!-- TODO: gray out the button if the form is not filled out correctly -->
                                <HyperlinkButton
                                    Padding="0"
                                    Margin="0,0,5,0"
                                    Command="{x:Bind ViewModel.ConfirmNewSessionCommand}">

                                    <FontIcon Glyph="&#xE930;" FontSize="15"
                                              Foreground="{ThemeResource SystemFillColorSuccessBrush}" />
                                </HyperlinkButton>
                                <HyperlinkButton
                                    Padding="0"
                                    Command="{x:Bind ViewModel.CancelNewSessionCommand}">

                                    <FontIcon Glyph="&#xF096;" FontSize="15"
                                              Foreground="{ThemeResource SystemFillColorCriticalBrush}" />
                                </HyperlinkButton>
                            </StackPanel>
                        </Border>
                        <Border Grid.Column="1" Padding="10,0,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBox
                                    Grid.Column="0"
                                    Margin="0,0,5,0"
                                    VerticalAlignment="Stretch"
                                    Text="{x:Bind ViewModel.NewSessionLocalPath, Mode=TwoWay}" />

                                <Button
                                    Grid.Column="1"
                                    IsEnabled="{x:Bind ViewModel.NewSessionLocalPathDialogOpen, Converter={StaticResource InverseBoolConverter}, Mode=OneWay}"
                                    Command="{x:Bind OpenLocalPathSelectDialogCommand}"
                                    VerticalAlignment="Stretch">

                                    <FontIcon Glyph="&#xE838;" FontSize="13" />
                                </Button>
                            </Grid>
                        </Border>
                        <Border Grid.Column="2">
                            <!-- TODO: use a combo box for workspace agents -->
                            <!--
                            <ComboBox
                                ItemsSource="{x:Bind WorkspaceAgents}"
                                VerticalAlignment="Stretch"
                                HorizontalAlignment="Stretch" />
                            -->
                            <TextBox
                                VerticalAlignment="Stretch"
                                HorizontalAlignment="Stretch"
                                Text="{x:Bind ViewModel.NewSessionRemoteHost, Mode=TwoWay}" />
                        </Border>
                        <Border Grid.Column="3">
                            <TextBox
                                VerticalAlignment="Stretch"
                                HorizontalAlignment="Stretch"
                                Text="{x:Bind ViewModel.NewSessionRemotePath, Mode=TwoWay}" />
                        </Border>
                    </Grid>
                </StackPanel>
            </ScrollView>
        </Grid>
    </Grid>
</Page>
